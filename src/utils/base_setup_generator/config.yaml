base_dockerfile_template: |
  ARG JAVA_VERSION=""

  FROM openjdk:${{JAVA_VERSION}}-slim

  MAINTAINER Mutlu Polatcan <mutlupolatcan@gmail.com>

  ENV HDUSER_HOME "/home/hduser"
  ENV HADOOP_HOME "${{HDUSER_HOME}}/hadoop"
  ENV HADOOP_CONF_DIR="${{HADOOP_HOME}}/etc/hadoop" \
      YARN_CONF_DIR="${{HADOOP_HOME}}/etc/hadoop" \
      HADOOP_TMP_DIR="${{HDUSER_HOME}}/app/hadoop/tmp" \
      PATH=$PATH:${{HADOOP_HOME}}/bin:${{HADOOP_HOME}}/sbin \
      LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${{HADOOP_HOME}}/lib/native/ \
      HADOOP_DAEMONS="NULL" \
      HADOOP_DFS_NAMESERVICES="" \
      HADOOP_WEBAPPS_HOSTNAME="0.0.0.0" \
      HADOOP_HEALTHCHECK_INTERVAL_IN_SECS="2" \
  {env_vars}

  ADD entrypoint.sh ${{HDUSER_HOME}}/hadoop_entrypoint.sh
  ADD config_loader.sh ${{HDUSER_HOME}}/hadoop_config_loader.sh

  RUN apt-get update && \
      apt-get -y install --no-install-recommends procps \
                                                 nano \
                                                 wget \
                                                 rsync \
                                                 gcc \
                                                 g++ \
                                                 unzip \
                                                 iputils-ping \
                                                 telnet \
                                                 dnsutils \
                                                 netcat && \
      rm -rf /var/lib/apt/lists/* && \
      addgroup hadoop && adduser --disabled-password --gecos "" --ingroup hadoop hduser && \
      mkdir -p ${{HADOOP_HOME}} ${{HADOOP_TMP_DIR}} && \
      chown -R hduser:hadoop ${{HDUSER_HOME}} && \
      chmod +x ${{HDUSER_HOME}}/hadoop_entrypoint.sh ${{HDUSER_HOME}}/hadoop_config_loader.sh

config_loader_sh_template: |
  #!/usr/bin/env bash

  function load_config() {{
      if [[ "$2" != "NULL" ]]
          then
              printf "\t<property>\n\t\t<name>$1</name>\n\t\t<value>$2</value>\n\t</property>\n" >> "${{HADOOP_CONF_DIR}}/$3"
      fi
  }}

  function load_config_with_opt() {{
      if [[ "$2" != "NULL" ]]
          then
              printf "\t<property>\n\t\t<name>$1</name>\n\t\t<value>$3</value>\n\t</property>\n" >> "${{HADOOP_CONF_DIR}}/$5"
      else
          printf "\t<property>\n\t\t<name>$1</name>\n\t\t<value>$4</value>\n\t</property>\n" >> "${{HADOOP_CONF_DIR}}/$5"
      fi
  }}

  {load_fn_calls}

config_files:
  - path: hadoop_configs/hdfs-site.yaml
    filename: hdfs-site.xml
  - path: hadoop_configs/yarn-site.yaml
    filename: yarn-site.xml
  - path: hadoop_configs/core-site.yaml
    filename: core-site.xml
  - path: hadoop_configs/mapred-site.yaml
    filename: mapred-site.xml

output_dir: ../../base